name: CD - DÃ©ploiement GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:  # Permet de dÃ©clencher manuellement

# Permissions spÃ©cifiques pour GitHub Pages
permissions:
  pages: write      # Pour publier sur Pages
  id-token: write   # Pour l'authentification

jobs:
  build-and-deploy:
    name: ğŸ—ï¸ Build et DÃ©ploiement
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
      
    - name: âš™ï¸ Configurer GitHub Pages
      uses: actions/configure-pages@v3
      
    - name: ğŸ” VÃ©rifier les fichiers sources
      run: |
        echo "=== VÃ‰RIFICATION PRÃ‰-BUILD ==="
        
        if [ ! -d "src" ]; then
          echo "âŒ ERREUR CRITIQUE: Dossier 'src/' introuvable"
          echo "Structure actuelle:"
          ls -la
          exit 1
        fi
        
        if [ ! -f "src/index.html" ]; then
          echo "âŒ ERREUR CRITIQUE: src/index.html introuvable"
          echo "Contenu de src/:"
          ls -la src/
          exit 1
        fi
        
        echo "âœ… Structure source valide"
        
    - name: ğŸ—ï¸ Construire le site
      run: |
        echo "=== CONSTRUCTION DU SITE ==="
        
        # CrÃ©er le dossier de dÃ©ploiement
        mkdir -p _site
        
        # Copier TOUS les fichiers de src/ vers _site/
        echo "ğŸ“ Copie des fichiers depuis src/..."
        cp -r src/* _site/
        
        # Ajouter un fichier de version (optionnel)
        echo "v1.0 - Build: ${{ github.sha }}" > _site/version.txt
        echo "$(date)" >> _site/version.txt
        
        echo "ğŸ“ Contenu final de _site/:"
        ls -la _site/
        echo ""
        echo "âœ… Construction terminÃ©e"
        
    - name: ğŸ“¤ TÃ©lÃ©verser l'artefact
      uses: actions/upload-pages-artifact@v2
      with:
        path: '_site'
        
    - name: ğŸš€ DÃ©ployer sur GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2
      
    - name: ğŸŒ Afficher l'URL du site
      if: success()
      run: |
        echo "========================================"
        echo "ğŸš€ DÃ‰PLOIEMENT RÃ‰USSI !"
        echo "========================================"
        echo "ğŸ“… $(date)"
        echo "ğŸŒ VOTRE SITE EST MAINTENANT EN LIGNE :"
        echo ""
        echo "   ğŸ”— https://audeflora.github.io/arcad-games/"
        echo ""
        echo "ğŸ“ Build: ${{ github.sha }}"
        echo "========================================"