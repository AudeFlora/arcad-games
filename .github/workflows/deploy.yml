name: CD - DÃ©ploiement sur GitHub Pages

on:
  push:
    branches: [main]

permissions:
  pages: write
  id-token: write

jobs:
  deploy:
    name: ğŸš€ DÃ©ploiement GitHub Pages
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    # 1. RÃ©cupÃ©rer le build (artefact CI ou code source)
    - name: ğŸ“¥ RÃ©cupÃ©rer le build
      uses: actions/download-artifact@v4
      with:
        name: web-app-build
        path: _site
      continue-on-error: true
      
    # 2. Fallback: build depuis source si artefact non trouvÃ©
    - name: ğŸ—ï¸ Build depuis source (fallback)
      if: steps.artifact.outcome != 'success'
      run: |
        echo "âš ï¸  Artefact non trouvÃ©, construction depuis source..."
        mkdir -p _site
        cp -r src/* _site/ 2>/dev/null || echo "Utilisation des fichiers directs"
        
    # 3. VÃ©rification du build
    - name: ğŸ” VÃ©rifier le build
      run: |
        echo "=== VÃ‰RIFICATION DU BUILD ==="
        
        if [ ! -f "_site/index.html" ]; then
          echo "âŒ ERREUR: Aucun index.html trouvÃ© pour le dÃ©ploiement"
          echo "Structure de _site/:"
          ls -la _site/ || echo "Dossier _site/ vide"
          exit 1
        fi
        
        echo "âœ… Build vÃ©rifiÃ©: _site/index.html prÃ©sent"
        echo "ğŸ“Š Taille du site: $(du -sh _site/)"
        
    # 4. Configuration GitHub Pages
    - name: âš™ï¸ Configurer GitHub Pages
      uses: actions/configure-pages@v3
      
    # 5. Upload pour dÃ©ploiement
    - name: ğŸ“¤ Uploader l'artefact Pages
      uses: actions/upload-pages-artifact@v2
      with:
        path: '_site'
        
    # 6. DÃ©ploiement
    - name: ğŸŒ DÃ©ployer sur GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2
      
    # 7. Notification GitHub Status
    - name: ğŸ“¢ Notification de statut
      if: always()
      run: |
        echo "=== NOTIFICATION DE STATUT ==="
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… DÃ‰PLOIEMENT RÃ‰USSI"
          echo "ğŸŒ URL: https://audeflora.github.io/arcad-games/"
          echo "ğŸš€ L'application est maintenant en ligne"
        else
          echo "âŒ DÃ‰PLOIEMENT Ã‰CHOUÃ‰"
          echo "ğŸ” VÃ©rifiez les logs pour plus de dÃ©tails"
        fi
        
        # CrÃ©ation d'un badge de statut (simulÃ©)
        echo ""
        echo "ğŸ“Š STATUT DU DÃ‰PLOIEMENT:"
        echo "----------------------------------------"
        echo "Application: Arcade Games"
        echo "Environnement: Production (GitHub Pages)"
        echo "Statut: ${{ job.status }}"
        echo "Date: $(date)"
        echo "Commit: ${{ github.sha }}"
        echo "URL: ${{ steps.deployment.outputs.page_url }}"
        echo "----------------------------------------"