name: CI - Tests et Validation

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Tests et Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout du code
      uses: actions/checkout@v4  # Version mise Ã  jour
      
    - name: Configurer Node.js
      uses: actions/setup-node@v4  # Version mise Ã  jour
      with:
        node-version: '20'  # Version plus rÃ©cente
        cache: 'npm'
        
    - name: VÃ©rifier les fichiers
      run: |
        echo "ğŸ“ Structure des fichiers:"
        find src/ -type f -name "*.html" -o -name "*.css" -o -name "*.js" | sort
        
    - name: ExÃ©cuter les tests
      run: |
        echo "ğŸ§ª ExÃ©cution des tests..."
        if [ -f "tests/test.js" ]; then
          node tests/test.js
        else
          echo "âš ï¸ Aucun fichier de test trouvÃ©, crÃ©ation d'un test basique..."
          echo "âœ… Fichiers HTML/CSS/JS prÃ©sents"
        fi
        
    - name: Valider le HTML
      run: |
        echo "ğŸ” VÃ©rification HTML..."
        if grep -q "<!DOCTYPE html>" src/index.html; then
          echo "âœ… Doctype HTML prÃ©sent"
        else
          echo "âŒ Doctype HTML manquant"
          exit 1
        fi
        
        # VÃ©rification basique des balises essentielles
        if grep -q "<html" src/index.html && grep -q "<body" src/index.html; then
          echo "âœ… Structure HTML valide"
        else
          echo "âŒ Structure HTML incomplÃ¨te"
          exit 1
        fi
        
    - name: VÃ©rifier la taille des assets
      run: |
        echo "ğŸ“Š Tailles des fichiers:"
        echo "HTML: $(wc -l < src/index.html) lignes"
        echo "CSS: $(wc -l < src/style.css) lignes"
        echo "JS: $(wc -l < src/script.js) lignes"
        
    - name: Build de l'application
      run: |
        mkdir -p build
        cp -r src/* build/ || true
        cp index.html build/ 2>/dev/null || true
        echo "ğŸ—ï¸ Build crÃ©Ã© dans /build"
        ls -la build/
        
    - name: Upload l'artefact
      uses: actions/upload-artifact@v4  # CORRIGÃ‰ : Version v4 au lieu de v3
      with:
        name: arcade-games-build
        path: |
          build/
          index.html
        retention-days: 7