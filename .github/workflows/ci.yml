name: CI - Tests et Validation

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main]

jobs:
  validate:
    name: Validation du code
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
      
    - name: ğŸ“Š Afficher la structure
      run: |
        echo "=== STRUCTURE DU PROJET ==="
        ls -la
        echo ""
        echo "=== CONTENU DE src/ ==="
        if [ -d "src" ]; then
          ls -la src/
        else
          echo "âŒ ERREUR: Dossier 'src/' non trouvÃ©"
          exit 1
        fi
        
    - name: ğŸ” Valider les fichiers essentiels
      run: |
        echo "=== VÃ‰RIFICATION DES FICHIERS ==="
        
        # VÃ©rifier index.html
        if [ ! -f "src/index.html" ]; then
          echo "âŒ ERREUR: src/index.html non trouvÃ©"
          exit 1
        fi
        echo "âœ… src/index.html prÃ©sent"
        
        # VÃ©rifier taille minimale
        LINES=$(wc -l < src/index.html)
        if [ $LINES -lt 20 ]; then
          echo "âš ï¸  Attention: index.html trÃ¨s court ($LINES lignes)"
        else
          echo "âœ… Taille OK: $LINES lignes"
        fi
        
    - name: ğŸ§ª Valider la structure HTML
      run: |
        echo "=== VALIDATION HTML ==="
        HTML_FILE="src/index.html"
        
        # Liste des vÃ©rifications
        CHECKS=(
          "<!DOCTYPE html>"
          "<html"
          "<head>"
          "<body>"
          "</html>"
        )
        
        ALL_OK=true
        for check in "${CHECKS[@]}"; do
          if grep -q "$check" "$HTML_FILE"; then
            echo "âœ… '$check' prÃ©sent"
          else
            echo "âŒ '$check' MANQUANT"
            ALL_OK=false
          fi
        done
        
        if [ "$ALL_OK" = false ]; then
          echo "âŒ Structure HTML incomplÃ¨te"
          exit 1
        fi
        
        echo "âœ… Structure HTML valide"
        
    - name: ğŸ“¦ CrÃ©er un build de test
      run: |
        echo "=== CRÃ‰ATION DU BUILD ==="
        mkdir -p build-test
        cp -r src/* build-test/ 2>/dev/null || true
        
        echo "ğŸ“ Contenu du build:"
        ls -la build-test/
        
    - name: â¬†ï¸ Sauvegarder l'artefact (optionnel)
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: build-test
        path: build-test/
        retention-days: 1
        
    - name: ğŸ‰ Rapport final
      if: always()
      run: |
        echo "========================================"
        echo "âœ… CI PIPELINE TERMINÃ‰E"
        echo "========================================"
        echo "ğŸ“… $(date)"
        echo "ğŸŒ¿ Branche: ${{ github.ref_name }}"
        echo "ğŸ”— Commit: ${{ github.sha }}"
        echo "========================================"